<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>语音助手客户端</title>
    <style>
        body {
            font-family: "PingFang SC", "Microsoft YaHei", "Helvetica Neue", Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }

        .connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .messages {
            border: 1px solid #ddd;
            height: 300px;
            overflow-y: auto;
            padding: 10px;
            margin: 15px 0;
            border-radius: 5px;
            background-color: #fafafa;
        }

        .message {
            margin: 8px 0;
            padding: 10px;
            border-radius: 8px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .user {
            background-color: #e3f2fd;
            margin-left: auto;
            text-align: right;
        }

        .assistant {
            background-color: #e8f5e9;
            margin-right: auto;
        }

        .system {
            background-color: #f5f5f5;
            font-style: italic;
            text-align: center;
            margin: 0 auto;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }

        button {
            padding: 10px 15px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            flex: 1;
            min-width: 120px;
        }

        button:hover {
            background-color: #2980b9;
        }

        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }

        #startBtn {
            background-color: #2ecc71;
        }

        #startBtn:hover {
            background-color: #27ae60;
        }

        #stopBtn {
            background-color: #e74c3c;
        }

        #stopBtn:hover {
            background-color: #c0392b;
        }

        #disconnectBtn {
            background-color: #95a5a6;
        }

        #disconnectBtn:hover {
            background-color: #7f8c8d;
        }

        .text-input {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }

        #textInput {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .mic-icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            background-color: #e74c3c;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
            position: relative;
        }

        .mic-icon::before {
            content: "";
            position: absolute;
            width: 8px;
            height: 12px;
            background-color: white;
            top: 4px;
            left: 6px;
            border-radius: 2px;
        }

        .mic-icon::after {
            content: "";
            position: absolute;
            width: 4px;
            height: 4px;
            background-color: white;
            bottom: 2px;
            left: 8px;
            border-radius: 50%;
        }

        .recording-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            background-color: #e74c3c;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .response-time {
            font-size: 12px;
            color: #7f8c8d;
            text-align: right;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>语音助手客户端</h1>

        <div id="status" class="status disconnected">
            未连接
        </div>

        <div class="controls">
            <button id="connectBtn" onclick="connect()">
                <span class="mic-icon"></span>连接服务
            </button>
            <button id="startBtn" onclick="startRecording()" disabled>
                <span class="recording-indicator"></span>开始录音
            </button>
            <button id="stopBtn" onclick="stopRecording()" disabled>停止录音</button>
            <button id="disconnectBtn" onclick="disconnect()" disabled>断开连接</button>
        </div>

        <div id="messages" class="messages"></div>

        <div class="text-input">
            <input type="text" id="textInput" placeholder="输入文本消息...">
            <button onclick="sendText()">发送</button>
        </div>
    </div>

    <script>
        let websocket = null;
        let mediaRecorder = null;
        let audioContext = null;
        let isRecording = false;
        let connectionTime = null;

        // 更新状态显示
        function updateStatus(message, isConnected) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${isConnected ? 'connected' : 'disconnected'}`;
        }

        // 添加消息到界面
        function addMessage(text, isUser = false, isSystem = false) {
            const messagesEl = document.getElementById('messages');
            const messageEl = document.createElement('div');

            if (isSystem) {
                messageEl.className = 'message system';
            } else {
                messageEl.className = `message ${isUser ? 'user' : 'assistant'}`;
            }

            messageEl.textContent = text;
            messagesEl.appendChild(messageEl);

            // 添加时间戳
            const timestamp = new Date().toLocaleTimeString();
            const timeEl = document.createElement('div');
            timeEl.className = 'response-time';
            timeEl.textContent = timestamp;
            messageEl.appendChild(timeEl);

            // 滚动到底部
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        // 连接WebSocket
        function connect() {
            const wsUrl = 'ws://localhost:8765';
            websocket = new WebSocket(wsUrl);

            websocket.onopen = function() {
                updateStatus('已连接到语音助手服务', true);
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('startBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = false;
                addMessage('系统: 已成功连接到语音助手服务', false, true);
                connectionTime = new Date();
            };

            websocket.onmessage = function(event) {
                const data = JSON.parse(event.data);

                if (data.type === 'welcome') {
                    addMessage(`系统: ${data.message}`, false, true);
                } else if (data.type === 'response') {
                    addMessage(`助手: ${data.text}`, false);
                } else if (data.type === 'notification') {
                    addMessage(`系统: ${data.message}`, false, true);
                }
            };

            websocket.onclose = function() {
                updateStatus('连接已断开', false);
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = true;
                addMessage('系统: 连接已断开', false, true);
                stopRecording();

                // 计算连接时长
                if (connectionTime) {
                    const duration = Math.round((new Date() - connectionTime) / 1000);
                    addMessage(`系统: 本次连接持续了 ${duration} 秒`, false, true);
                    connectionTime = null;
                }
            };

            websocket.onerror = function(error) {
                console.error('WebSocket错误:', error);
                addMessage('系统: 连接错误，请检查服务是否运行', false, true);
            };
        }

        // 开始录音
        async function startRecording() {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                alert('请先连接到服务器');
                return;
            }

            try {
                // 获取麦克风权限
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                // 创建音频上下文
                audioContext = new AudioContext({ sampleRate: 16000 });
                const source = audioContext.createMediaStreamSource(stream);

                // 创建处理器
                const processor = audioContext.createScriptProcessor(1024, 1, 1);

                processor.onaudioprocess = function(event) {
                    if (!isRecording) return;

                    // 获取音频数据
                    const inputData = event.inputBuffer.getChannelData(0);
                    const int16Data = new Int16Array(inputData.length);

                    // 转换为16位整数
                    for (let i = 0; i < inputData.length; i++) {
                        int16Data[i] = Math.max(-32768, Math.min(32767, inputData[i] * 32768));
                    }

                    // 转换为Base64
                    const binaryString = String.fromCharCode.apply(null, int16Data);
                    const base64Data = btoa(binaryString);

                    // 发送音频数据
                    if (websocket && websocket.readyState === WebSocket.OPEN) {
                        websocket.send(JSON.stringify({
                            type: 'audio',
                            data: base64Data
                        }));
                    }
                };

                source.connect(processor);
                processor.connect(audioContext.destination);

                isRecording = true;
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                addMessage('系统: 开始录音...', false, true);

            } catch (error) {
                console.error('开始录音错误:', error);
                alert('无法访问麦克风: ' + error.message);
            }
        }

        // 停止录音
        function stopRecording() {
            isRecording = false;

            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({
                    type: 'stop'
                }));
            }

            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            addMessage('系统: 停止录音', false, true);
        }

        // 断开连接
        function disconnect() {
            if (websocket) {
                websocket.close();
            }
        }

        // 发送文本消息
        function sendText() {
            const textInput = document.getElementById('textInput');
            const text = textInput.value.trim();

            if (!text) return;

            if (websocket && websocket.readyState === WebSocket.OPEN) {
                // 模拟音频消息格式发送文本
                websocket.send(JSON.stringify({
                    type: 'text',
                    data: text
                }));

                addMessage(`你: ${text}`, true);
                textInput.value = '';
            } else {
                alert('请先连接到服务器');
            }
        }

        // 回车发送文本
        document.getElementById('textInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendText();
            }
        });

        // 页面加载时添加欢迎消息
        window.onload = function() {
            addMessage('系统: 欢迎使用语音助手客户端', false, true);
            addMessage('系统: 请点击"连接服务"按钮开始', false, true);
        };
    </script>
</body>
</html>